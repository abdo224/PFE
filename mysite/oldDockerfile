# Build stage
FROM python:3.8 AS build
ENV PYTHONUNBUFFERED=1
WORKDIR /django
COPY requirements.txt requirements.txt
RUN pip3 install -r requirements.txt
COPY . .

# Production stage
FROM python:3.8-slim AS production
ENV DB_NAME=django-app-db
ENV DB_USER=root
ENV DB_PASSWORD=
ENV DB_HOST=db
ENV DB_URL=
WORKDIR /django
COPY --from=build /django /django
RUN sed -i 's/localhost/$DB_HOST/g' /django/mysite/settings.py
RUN sed -i 's/dbname/$DB_NAME/g' /django/mysite/settings.py
RUN sed -i 's/dbuser/$DB_USER/g' /django/mysite/settings.py
RUN sed -i 's/dbpassword/$DB_PASSWORD/g' /django/mysite/settings.py